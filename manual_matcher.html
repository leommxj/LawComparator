<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³•å¾‹æ¡æ–‡æ‰‹åŠ¨åŒ¹é…å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }

        .file-input {
            display: none;
        }

        .file-label {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .file-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-left: auto;
            font-size: 14px;
            color: #6c757d;
        }

        .main-content {
            display: flex;
            height: 700px;
        }

        .panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #e9ecef;
        }

        .panel:last-child {
            border-right: none;
        }

        .panel-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            text-align: center;
            font-weight: 600;
            font-size: 1.1em;
            color: #495057;
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .article-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .article-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .article-item.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3), 0 4px 20px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px) scale(1.02);
        }

        .article-item.matched {
            border-color: #28a745;
            background: #d4edda;
            color: #155724;
        }

        .article-item.matched.selected {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.3), 0 4px 20px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px) scale(1.02);
        }

        .article-item.auto-matched {
            border-color: #17a2b8;
            background: #d1ecf1;
            color: #0c5460;
        }

        .article-item.auto-matched.selected {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            box-shadow: 0 0 0 3px rgba(23, 162, 184, 0.3), 0 4px 20px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px) scale(1.02);
        }

        .article-item.hidden {
            display: none;
        }

        .article-number {
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 8px;
            color: #667eea;
        }

        .article-item.selected .article-number,
        .article-item.matched.selected .article-number {
            color: white;
        }

        .article-item.matched .article-number {
            color: #28a745;
        }

        .article-content {
            font-size: 14px;
            line-height: 1.6;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .match-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #28a745;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }

        .matches-panel {
            border-left: 1px solid #e9ecef;
        }

        .match-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
        }

        .match-item .match-pair {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .match-item .old-article,
        .match-item .new-article {
            font-weight: 600;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
        }

        .match-item .old-article {
            background: #fff3cd;
            color: #856404;
        }

        .match-item .new-article {
            background: #d1ecf1;
            color: #0c5460;
        }

        .match-item .remove-match {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .empty-state {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            margin-top: 50px;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #6c757d;
            font-size: 16px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: #dc3545;
        }

        .notification.info {
            background: #17a2b8;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(3px);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border: none;
            border-radius: 12px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 25px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .modal-close:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 25px;
            max-height: 60vh;
            overflow-y: auto;
            line-height: 1.8;
            font-size: 16px;
            color: #333;
        }

        .modal-body p {
            margin: 0 0 15px 0;
            text-align: justify;
        }

        .modal-body .article-meta {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 0 8px 8px 0;
        }

        .modal-body .article-meta strong {
            color: #007bff;
        }

        /* æ¡æ–‡é¡¹å¢åŠ æŸ¥çœ‹æç¤º */
        .article-item {
            position: relative;
        }

        .article-item::after {
            content: "ğŸ‘† ç‚¹å‡»é€‰æ‹© ğŸ‘ï¸ åŒå‡»æŸ¥çœ‹";
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            z-index: 10;
            white-space: nowrap;
        }

        .article-item:hover::after {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
                height: auto;
            }
            
            .panel {
                border-right: none;
                border-bottom: 1px solid #e9ecef;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .stats {
                margin-left: 0;
                justify-content: center;
            }
            
            /* ç§»åŠ¨è®¾å¤‡ä¸Šçš„æ¨¡æ€æ¡†ä¼˜åŒ– */
            .modal-content {
                width: 95%;
                margin: 2% auto;
                max-height: 95vh;
            }
            
            .modal-body {
                padding: 15px;
                max-height: 70vh;
            }
            
            .article-item::after {
                content: "ğŸ‘† ç‚¹é€‰";
                font-size: 10px;
                padding: 2px 4px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>æ³•å¾‹æ¡æ–‡æ‰‹åŠ¨åŒ¹é…å·¥å…·</h1>
            <p>ğŸ“Œ <strong>æ“ä½œè¯´æ˜ï¼š</strong>ç‚¹å‡»æ¡æ–‡é€‰æ‹©/å–æ¶ˆé€‰æ‹©ï¼Œä¸¤è¾¹éƒ½é€‰ä¸­æ—¶è‡ªåŠ¨å»ºç«‹åŒ¹é… â€¢ åŒå‡»æ¡æ–‡æŸ¥çœ‹å…¨æ–‡å†…å®¹</p>
        </div>

        <div class="controls">
            <label for="dataFile" class="file-label">ğŸ“ åŠ è½½å¯¹æ¯”æ•°æ®</label>
            <input type="file" id="dataFile" class="file-input" accept=".json">
            
            <button class="btn" onclick="saveMatches()">ğŸ’¾ ä¿å­˜åŒ¹é…ç»“æœ</button>
            <button class="btn btn-secondary" onclick="loadMatches()">ğŸ“¤ åŠ è½½åŒ¹é…ç»“æœ</button>
            <button class="btn btn-danger" onclick="clearMatches()">ğŸ—‘ï¸ æ¸…ç©ºåŒ¹é…</button>
            
            <button class="btn" id="toggleView" onclick="toggleViewMode()" style="background: linear-gradient(135deg, #fd7e14 0%, #e76500 100%);">
                ğŸ‘ï¸ æ˜¾ç¤ºæ‰€æœ‰æ¡æ–‡
            </button>
            
            <div class="stats">
                <span>åŸç‰ˆæ¡æ–‡: <strong id="originalCount">0</strong></span>
                <span>æ–°ç‰ˆæ¡æ–‡: <strong id="newVersionCount">0</strong></span>
                <span>æ‰‹åŠ¨åŒ¹é…: <strong id="matchedCount">0</strong></span>
            </div>
        </div>

        <div class="main-content">
            <div class="panel">
                <div class="panel-header" id="oldPanelHeader" style="background: #fff3cd; color: #856404;">
                    ğŸ“‰ åŸç‰ˆæ³•æ¡ (æœªåŒ¹é…)
                </div>
                <div class="panel-content" id="oldPanel">
                    <div class="loading">è¯·å…ˆåŠ è½½å¯¹æ¯”æ•°æ®æ–‡ä»¶</div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header" id="newPanelHeader" style="background: #d1ecf1; color: #0c5460;">
                    ğŸ“ˆ æ–°ç‰ˆæ³•æ¡ (æœªåŒ¹é…)
                </div>
                <div class="panel-content" id="newPanel">
                    <div class="loading">è¯·å…ˆåŠ è½½å¯¹æ¯”æ•°æ®æ–‡ä»¶</div>
                </div>
            </div>

            <div class="panel matches-panel">
                <div class="panel-header" style="background: #d4edda; color: #155724;">
                    ğŸ”— åŒ¹é…å…³ç³» (<span id="matchCount">0</span>)
                </div>
                <div class="panel-content" id="matchesPanel">
                    <div class="empty-state">æš‚æ— åŒ¹é…å…³ç³»</div>
                </div>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <!-- æŸ¥çœ‹å…¨æ–‡æ¨¡æ€æ¡† -->
    <div id="articleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">æ¡æ–‡è¯¦æƒ…</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- å†…å®¹å°†é€šè¿‡JavaScriptå¡«å…… -->
            </div>
        </div>
    </div>

    <script>
        let comparisonData = null;
        let manualMatches = [];
        let selectedOld = null;
        let selectedNew = null;
        let currentDeletedArticles = [];
        let currentNewArticles = [];
        let allOldArticles = [];
        let allNewArticles = [];
        let autoMatches = [];
        let showAllArticles = false;

        // åŠ è½½å¯¹æ¯”æ•°æ®
        document.getElementById('dataFile').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        comparisonData = JSON.parse(e.target.result);
                        loadData();
                        showNotification('æ•°æ®åŠ è½½æˆåŠŸï¼');
                    } catch (error) {
                        showNotification('æ•°æ®æ ¼å¼é”™è¯¯ï¼š' + error.message, 'error');
                    }
                };
                reader.readAsText(file);
            }
        });

        function loadData() {
            if (!comparisonData) return;

            // æ”¯æŒä¸¤ç§æ•°æ®æ ¼å¼ï¼šç›´æ¥æ ¼å¼å’ŒåµŒå¥—æ ¼å¼
            let deletedArticles, newArticles, identicalArticles, modifiedArticles, mapping;
            
            if (comparisonData.comparison_result) {
                // åµŒå¥—æ ¼å¼ï¼ˆä»æ³•å¾‹æ¡æ–‡å¯¹æ¯”æ•°æ®.jsonï¼‰
                const result = comparisonData.comparison_result;
                deletedArticles = result.deleted || result.deleted_articles || [];
                newArticles = result.new || result.new_articles || [];
                identicalArticles = result.identical || [];
                modifiedArticles = result.modified || [];
                mapping = result.mapping || {};
            } else {
                // ç›´æ¥æ ¼å¼
                deletedArticles = comparisonData.deleted || comparisonData.deleted_articles || [];
                newArticles = comparisonData.new || comparisonData.new_articles || [];
                identicalArticles = comparisonData.identical || [];
                modifiedArticles = comparisonData.modified || [];
                mapping = comparisonData.mapping || {};
            }

            // æ„å»ºæ‰€æœ‰åŸç‰ˆæ¡æ–‡æ•°æ®
            allOldArticles = [
                ...deletedArticles.map(article => ({...article, article_number: String(article.article_number), status: 'deleted'})),
                ...identicalArticles.map(article => ({
                    article_number: String(article.old_number),
                    content: article.content,
                    status: 'identical',
                    matched_to: String(article.new_number)
                })),
                ...modifiedArticles.map(article => ({
                    article_number: String(article.old_number),
                    content: article.old_content,
                    status: 'modified',
                    matched_to: String(article.new_number)
                }))
            ].sort((a, b) => parseInt(a.article_number) - parseInt(b.article_number));

            // æ„å»ºæ‰€æœ‰æ–°ç‰ˆæ¡æ–‡æ•°æ®
            allNewArticles = [
                ...newArticles.map(article => ({...article, article_number: String(article.article_number), status: 'new'})),
                ...identicalArticles.map(article => ({
                    article_number: String(article.new_number),
                    content: article.content,
                    status: 'identical',
                    matched_from: String(article.old_number)
                })),
                ...modifiedArticles.map(article => ({
                    article_number: String(article.new_number),
                    content: article.new_content,
                    status: 'modified',
                    matched_from: String(article.old_number)
                }))
            ].sort((a, b) => parseInt(a.article_number) - parseInt(b.article_number));

            // ä¿å­˜æ•°æ®å¼•ç”¨ç”¨äºå…¼å®¹æ€§
            currentDeletedArticles = deletedArticles;
            currentNewArticles = newArticles;

            // æ„å»ºè‡ªåŠ¨åŒ¹é…å…³ç³»
            autoMatches = [
                ...identicalArticles.map(article => ({
                    old_number: article.old_number.toString(),
                    new_number: article.new_number.toString(),
                    type: 'auto',
                    similarity: article.similarity || 1.0
                })),
                ...modifiedArticles.map(article => ({
                    old_number: article.old_number.toString(),
                    new_number: article.new_number.toString(),
                    type: 'auto',
                    similarity: article.similarity || 0.8
                }))
            ];

            console.log('åŸç‰ˆæ¡æ–‡æ€»æ•°:', allOldArticles.length);
            console.log('æ–°ç‰ˆæ¡æ–‡æ€»æ•°:', allNewArticles.length);
            console.log('è‡ªåŠ¨åŒ¹é…æ•°é‡:', autoMatches.length);

            renderArticles();
            updateStats();
        }

        function renderArticles() {
            renderOldArticles();
            renderNewArticles();
            updatePanelHeaders();
            updateArticleStatus();
        }

        function renderOldArticles() {
            const panel = document.getElementById('oldPanel');
            
            // æ ¹æ®æ˜¾ç¤ºæ¨¡å¼è¿‡æ»¤æ¡æ–‡
            let articlesToShow = allOldArticles;
            if (!showAllArticles) {
                articlesToShow = allOldArticles.filter(article => 
                    article.status === 'deleted' || isManuallyMatched(article.article_number, 'old')
                );
            }

            if (articlesToShow.length === 0) {
                const mode = showAllArticles ? 'æ‰€æœ‰' : 'æœªåŒ¹é…çš„';
                panel.innerHTML = `<div class="empty-state">æ²¡æœ‰${mode}åŸç‰ˆæ³•æ¡</div>`;
                return;
            }

            panel.innerHTML = articlesToShow.map((article, index) => {
                const originalIndex = allOldArticles.findIndex(a => a.article_number === article.article_number);
                let statusClass = '';
                let statusIndicator = '';
                
                if (isManuallyMatched(article.article_number, 'old')) {
                    statusClass = 'matched';
                    statusIndicator = '<div class="match-indicator">âœ“</div>';
                } else if (article.status === 'identical' || article.status === 'modified') {
                    statusClass = 'auto-matched';
                    statusIndicator = `<div class="match-indicator" style="background: #17a2b8;">ğŸ”—</div>`;
                }

                return `
                    <div class="article-item ${statusClass}" data-type="old" data-number="${article.article_number}" 
                         data-index="${originalIndex}" data-status="${article.status}"
                         onclick="selectArticle(this)" ondblclick="showArticleModalByIndex('old', ${originalIndex})">
                        <div class="article-number">ç¬¬${article.article_number}æ¡ ${getStatusBadge(article.status)}</div>
                        <div class="article-content">${article.content}</div>
                        ${statusIndicator}
                    </div>
                `;
            }).join('');
        }

        function renderNewArticles() {
            const panel = document.getElementById('newPanel');
            
            // æ ¹æ®æ˜¾ç¤ºæ¨¡å¼è¿‡æ»¤æ¡æ–‡
            let articlesToShow = allNewArticles;
            if (!showAllArticles) {
                articlesToShow = allNewArticles.filter(article => 
                    article.status === 'new' || isManuallyMatched(article.article_number, 'new')
                );
            }

            if (articlesToShow.length === 0) {
                const mode = showAllArticles ? 'æ‰€æœ‰' : 'æœªåŒ¹é…çš„';
                panel.innerHTML = `<div class="empty-state">æ²¡æœ‰${mode}æ–°ç‰ˆæ³•æ¡</div>`;
                return;
            }

            panel.innerHTML = articlesToShow.map((article, index) => {
                const originalIndex = allNewArticles.findIndex(a => a.article_number === article.article_number);
                let statusClass = '';
                let statusIndicator = '';
                
                if (isManuallyMatched(article.article_number, 'new')) {
                    statusClass = 'matched';
                    statusIndicator = '<div class="match-indicator">âœ“</div>';
                } else if (article.status === 'identical' || article.status === 'modified') {
                    statusClass = 'auto-matched';
                    statusIndicator = `<div class="match-indicator" style="background: #17a2b8;">ğŸ”—</div>`;
                }

                return `
                    <div class="article-item ${statusClass}" data-type="new" data-number="${article.article_number}" 
                         data-index="${originalIndex}" data-status="${article.status}"
                         onclick="selectArticle(this)" ondblclick="showArticleModalByIndex('new', ${originalIndex})">
                        <div class="article-number">ç¬¬${article.article_number}æ¡ ${getStatusBadge(article.status)}</div>
                        <div class="article-content">${article.content}</div>
                        ${statusIndicator}
                    </div>
                `;
            }).join('');
        }

        function getStatusBadge(status) {
            const badges = {
                'deleted': '<span style="background: #dc3545; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px;">åˆ é™¤</span>',
                'new': '<span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px;">æ–°å¢</span>',
                'identical': '<span style="background: #17a2b8; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px;">ç›¸åŒ</span>',
                'modified': '<span style="background: #ffc107; color: #212529; padding: 2px 6px; border-radius: 3px; font-size: 10px;">ä¿®æ”¹</span>'
            };
            return badges[status] || '';
        }

        function updatePanelHeaders() {
            const oldHeader = document.getElementById('oldPanelHeader');
            const newHeader = document.getElementById('newPanelHeader');
            
            if (showAllArticles) {
                oldHeader.innerHTML = 'ğŸ“‹ åŸç‰ˆæ³•æ¡ (å…¨éƒ¨)';
                newHeader.innerHTML = 'ğŸ“‹ æ–°ç‰ˆæ³•æ¡ (å…¨éƒ¨)';
            } else {
                oldHeader.innerHTML = 'ğŸ“‰ åŸç‰ˆæ³•æ¡ (æœªåŒ¹é…)';
                newHeader.innerHTML = 'ğŸ“ˆ æ–°ç‰ˆæ³•æ¡ (æœªåŒ¹é…)';
            }
        }

        function toggleViewMode() {
            showAllArticles = !showAllArticles;
            const toggleBtn = document.getElementById('toggleView');
            
            if (showAllArticles) {
                toggleBtn.innerHTML = 'ğŸ‘ï¸ åªæ˜¾ç¤ºæœªåŒ¹é…';
                toggleBtn.style.background = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';
            } else {
                toggleBtn.innerHTML = 'ğŸ‘ï¸ æ˜¾ç¤ºæ‰€æœ‰æ¡æ–‡';
                toggleBtn.style.background = 'linear-gradient(135deg, #fd7e14 0%, #e76500 100%)';
            }
            
            renderArticles();
            showNotification(showAllArticles ? 'å·²åˆ‡æ¢åˆ°æ˜¾ç¤ºæ‰€æœ‰æ¡æ–‡' : 'å·²åˆ‡æ¢åˆ°åªæ˜¾ç¤ºæœªåŒ¹é…æ¡æ–‡', 'info');
        }

        function selectArticle(element) {
            const type = element.dataset.type;
            const number = element.dataset.number;
            const status = element.dataset.status;
            const isCurrentlySelected = element.classList.contains('selected');

            if (isCurrentlySelected) {
                // å¦‚æœå½“å‰æ¡æ–‡å·²è¢«é€‰ä¸­ï¼Œåˆ™å–æ¶ˆé€‰æ‹©
                element.classList.remove('selected');
                
                if (type === 'old') {
                    selectedOld = null;
                } else {
                    selectedNew = null;
                }
                
                showNotification(`å·²å–æ¶ˆé€‰æ‹©ç¬¬${number}æ¡`, 'info');
            } else {
                // æ£€æŸ¥æ˜¯å¦è¯•å›¾é€‰æ‹©å·²æœ‰è‡ªåŠ¨åŒ¹é…çš„æ¡æ–‡
                if ((status === 'identical' || status === 'modified') && !showAllArticles) {
                    showNotification(`ç¬¬${number}æ¡å·²æœ‰è‡ªåŠ¨åŒ¹é…ï¼Œè¯·åˆ‡æ¢åˆ°"æ˜¾ç¤ºæ‰€æœ‰æ¡æ–‡"æ¨¡å¼è¿›è¡Œé‡æ–°åŒ¹é…`, 'info');
                    return;
                }

                // æ¸…é™¤åŒç±»å‹çš„å…¶ä»–é€‰æ‹©
                document.querySelectorAll(`[data-type="${type}"]`).forEach(el => {
                    el.classList.remove('selected');
                });

                // é€‰æ‹©å½“å‰é¡¹
                element.classList.add('selected');

                if (type === 'old') {
                    selectedOld = number;
                } else {
                    selectedNew = number;
                }

                const statusText = status ? ` (${getStatusText(status)})` : '';
                showNotification(`å·²é€‰æ‹©ç¬¬${number}æ¡${statusText}`, 'info');

                // å¦‚æœä¸¤è¾¹éƒ½æœ‰é€‰æ‹©ï¼Œåˆ›å»ºåŒ¹é…
                if (selectedOld && selectedNew) {
                    createMatch(selectedOld, selectedNew);
                    clearSelections();
                }
            }
        }

        function getStatusText(status) {
            const statusTexts = {
                'deleted': 'åˆ é™¤',
                'new': 'æ–°å¢',
                'identical': 'ç›¸åŒ',
                'modified': 'ä¿®æ”¹'
            };
            return statusTexts[status] || status;
        }

        function createMatch(oldNumber, newNumber) {
            // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨æ‰‹åŠ¨åŒ¹é…
            const existingManualMatch = manualMatches.find(match => 
                match.old_number === String(oldNumber) || match.new_number === String(newNumber)
            );

            if (existingManualMatch) {
                showNotification(`ç¬¬${oldNumber}æ¡æˆ–ç¬¬${newNumber}æ¡å·²æœ‰æ‰‹åŠ¨åŒ¹é…å…³ç³»`, 'error');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å­˜åœ¨è‡ªåŠ¨åŒ¹é…
            const existingAutoMatch = autoMatches.find(match =>
                match.old_number === String(oldNumber) || match.new_number === String(newNumber)
            );

            let message = `åŒ¹é…æˆåŠŸï¼šç¬¬${oldNumber}æ¡ â†” ç¬¬${newNumber}æ¡`;
            if (existingAutoMatch) {
                message += ' (è¦†ç›–äº†è‡ªåŠ¨åŒ¹é…)';
            }

            // æ·»åŠ æ–°åŒ¹é…
            manualMatches.push({
                old_number: String(oldNumber),
                new_number: String(newNumber),
                type: 'manual'
            });

            // æ›´æ–°æ˜¾ç¤º
            renderMatches();
            renderArticles(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°çŠ¶æ€
            updateStats();
            showNotification(message);
        }

        function removeMatch(index) {
            manualMatches.splice(index, 1);
            renderMatches();
            renderArticles(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°çŠ¶æ€
            updateStats();
            showNotification('åŒ¹é…å…³ç³»å·²åˆ é™¤');
        }

        function renderMatches() {
            const panel = document.getElementById('matchesPanel');
            const matchCount = document.getElementById('matchCount');
            
            matchCount.textContent = manualMatches.length;

            if (manualMatches.length === 0) {
                panel.innerHTML = '<div class="empty-state">æš‚æ— åŒ¹é…å…³ç³»</div>';
                return;
            }

            panel.innerHTML = manualMatches.map((match, index) => `
                <div class="match-item">
                    <div class="match-pair">
                        <div class="old-article">ç¬¬${match.old_number}æ¡</div>
                        <div style="color: #6c757d;">â†”</div>
                        <div class="new-article">ç¬¬${match.new_number}æ¡</div>
                    </div>
                    <button class="remove-match" onclick="removeMatch(${index})" title="åˆ é™¤åŒ¹é…">Ã—</button>
                </div>
            `).join('');
        }

        function updateArticleStatus() {
            // è¿™ä¸ªå‡½æ•°ç°åœ¨åœ¨renderArticlesä¸­å¤„ç†ï¼Œä¿ç•™ä¸ºå…¼å®¹æ€§
        }

        function isManuallyMatched(number, type) {
            if (type === 'old') {
                return manualMatches.some(match => match.old_number === String(number));
            } else {
                return manualMatches.some(match => match.new_number === String(number));
            }
        }

        function isAutoMatched(number, type) {
            if (type === 'old') {
                return autoMatches.some(match => match.old_number === String(number));
            } else {
                return autoMatches.some(match => match.new_number === String(number));
            }
        }

        function clearSelections() {
            document.querySelectorAll('.article-item').forEach(el => {
                el.classList.remove('selected');
            });
            selectedOld = null;
            selectedNew = null;
        }

        function updateStats() {
            if (!comparisonData) return;

            const originalCount = allOldArticles.length;
            const newVersionCount = allNewArticles.length;
            const matchedCount = manualMatches.length;

            document.getElementById('originalCount').textContent = originalCount;
            document.getElementById('newVersionCount').textContent = newVersionCount;
            document.getElementById('matchedCount').textContent = matchedCount;
        }

        function saveMatches() {
            if (manualMatches.length === 0) {
                showNotification('æ²¡æœ‰åŒ¹é…å…³ç³»å¯ä¿å­˜', 'error');
                return;
            }

            const data = {
                manual_matches: manualMatches,
                total_matches: manualMatches.length
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'manual_matches.json';
            a.click();
            URL.revokeObjectURL(url);

            showNotification(`å·²ä¿å­˜ ${manualMatches.length} ä¸ªåŒ¹é…å…³ç³»`);
        }

        function loadMatches() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            manualMatches = data.manual_matches || [];
                            renderMatches();
                            renderArticles(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°çŠ¶æ€
                            updateStats();
                            showNotification(`å·²åŠ è½½ ${manualMatches.length} ä¸ªåŒ¹é…å…³ç³»`);
                        } catch (error) {
                            showNotification('åŒ¹é…æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼š' + error.message, 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function clearMatches() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰åŒ¹é…å…³ç³»å—ï¼Ÿ')) {
                manualMatches = [];
                renderMatches();
                renderArticles(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°çŠ¶æ€
                updateStats();
                showNotification('å·²æ¸…ç©ºæ‰€æœ‰åŒ¹é…å…³ç³»');
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // é€šè¿‡ç´¢å¼•æ˜¾ç¤ºæ¡æ–‡å…¨æ–‡æ¨¡æ€æ¡†
        function showArticleModalByIndex(type, index) {
            const modal = document.getElementById('articleModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            // è·å–æ¡æ–‡æ•°æ®
            let article;
            if (type === 'old') {
                article = allOldArticles[index];
            } else if (type === 'new') {
                article = allNewArticles[index];
            } else if (type === 'deleted') {
                // å…¼å®¹æ€§æ”¯æŒ
                article = currentDeletedArticles[index];
            } else {
                // å…¼å®¹æ€§æ”¯æŒ
                article = currentNewArticles[index];
            }
            
            if (!article) {
                showNotification('æ¡æ–‡æ•°æ®ä¸å­˜åœ¨', 'error');
                return;
            }
            
            // è®¾ç½®æ ‡é¢˜å’Œé¢œè‰²
            const statusTexts = {
                'deleted': { text: 'åˆ é™¤çš„æ³•æ¡', color: '#dc3545' },
                'new': { text: 'æ–°å¢çš„æ³•æ¡', color: '#28a745' },
                'identical': { text: 'ç›¸åŒçš„æ³•æ¡', color: '#17a2b8' },
                'modified': { text: 'ä¿®æ”¹çš„æ³•æ¡', color: '#ffc107' },
                'old': { text: 'åŸç‰ˆæ³•æ¡', color: '#856404' }
            };
            
            const statusInfo = statusTexts[article.status] || statusTexts[type] || { text: 'æ³•æ¡', color: '#6c757d' };
            modalTitle.innerHTML = `<span style="color: ${statusInfo.color};">${statusInfo.text}</span> - ç¬¬${article.article_number}æ¡`;
            
            // æ ¼å¼åŒ–å†…å®¹
            const paragraphs = article.content.split('\n').filter(p => p.trim());
            const formattedContent = paragraphs.map(p => `<p>${p.trim()}</p>`).join('');
            
            // æ„å»ºåŒ¹é…ä¿¡æ¯
            let matchInfo = '';
            if (article.status === 'identical' || article.status === 'modified') {
                const matchedTo = article.matched_to || article.matched_from;
                if (matchedTo) {
                    matchInfo = `<strong>è‡ªåŠ¨åŒ¹é…ï¼š</strong>ç¬¬${matchedTo}æ¡<br>`;
                }
            }
            if (isManuallyMatched(article.article_number, type)) {
                const manualMatch = manualMatches.find(match => 
                    match.old_number === String(article.article_number) || match.new_number === String(article.article_number)
                );
                if (manualMatch) {
                    const targetNumber = manualMatch.old_number === String(article.article_number) ? manualMatch.new_number : manualMatch.old_number;
                    matchInfo += `<strong>æ‰‹åŠ¨åŒ¹é…ï¼š</strong>ç¬¬${targetNumber}æ¡<br>`;
                }
            }
            
            modalBody.innerHTML = `
                <div class="article-meta">
                    <strong>æ¡æ–‡ç¼–å·ï¼š</strong>ç¬¬${article.article_number}æ¡<br>
                    <strong>æ¡æ–‡çŠ¶æ€ï¼š</strong>${statusInfo.text}<br>
                    ${matchInfo}
                    <strong>å†…å®¹é•¿åº¦ï¼š</strong>${article.content.length}å­—ç¬¦<br>
                    <strong>æ®µè½æ•°é‡ï¼š</strong>${paragraphs.length}æ®µ
                </div>
                <div class="article-full-content">
                    ${formattedContent}
                </div>
            `;
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden'; // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
            
            // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼ˆé˜²æ­¢åŒæ—¶è§¦å‘é€‰æ‹©äº‹ä»¶ï¼‰
            event.stopPropagation();
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            const modal = document.getElementById('articleModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto'; // æ¢å¤èƒŒæ™¯æ»šåŠ¨
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
        document.getElementById('articleModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeModal();
            }
        });

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey || event.metaKey) {
                switch (event.key) {
                    case 's':
                        event.preventDefault();
                        saveMatches();
                        break;
                    case 'o':
                        event.preventDefault();
                        loadMatches();
                        break;
                }
            }
            if (event.key === 'Escape') {
                // å¦‚æœæ¨¡æ€æ¡†æ‰“å¼€ï¼Œå…ˆå…³é—­æ¨¡æ€æ¡†
                const modal = document.getElementById('articleModal');
                if (modal.style.display === 'block') {
                    closeModal();
                } else {
                    clearSelections();
                }
            }
        });
    </script>
</body>
</html> 